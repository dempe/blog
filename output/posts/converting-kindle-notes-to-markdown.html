<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A personal blog by Chris Dempewolf about science, technology, and computation."/>
    <link rel="stylesheet" href="../assets/css/output.css"/>
    <script src="../assets/js/highlight.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="icon" href="../assets/img/favicon.png" type="image/png">
    <title>Chris Dempewolf's Blog</title>
</head>
<body class="bg-[#0a0a0a] text-neutral-300 font-sans my-2 mx-auto sm:w-[90%] md:w-[80%] lg:w-[700px] xl:w-[1024px] px-4 sm:px-6 md:px-8 lg:px-10 xl:px-12">
<header class="flex flex-col mb-6">
    <a class="text-3xl font-bold no-underline text-stone-200 hover:text-chartreuse text-7xl" href="../index.html"><span style="font-family: 'HanSerif';">初心 </span><br>Shoshin</a>
    <nav class="flex space-x-4 mt-2 mb-8">
        <a class="" href="../about.html">About</a>
        
        <a href="../resume.pdf" target="_blank">Resume</a>
        <a href="../tags/index.html">Tags</a>
        <a href="../feed.rss" target="_blank">RSS</a>
        <a href="../stats.html" target="_blank">Stats</a>
    </nav>
</header>
<main>
    <article class="my-9 pb-9">
        <h1 class="text-3xl font-bold my-2">    Converting Kindle Notes to Markdown
</h1>
                    <table class="mb-16 text-sm text-stone-400 font-normal no-underline">
                    <tr>
        <td>Published:&nbsp;&nbsp;</td>
        <td>2023-07-20 09:46</td>
    </tr>
            <tr>
            <td>Updated:&nbsp;&nbsp;</td>
            <td>
                2023-08-03 12:17
            </td>
        </tr>
        <tr>
        <td>Tags:&nbsp;&nbsp;</td>
        <td>
                            <a href="../tags/perl.html">perl</a>&nbsp;
                            <a href="../tags/python.html">python</a>&nbsp;
                            <a href="../tags/regex.html">regex</a>&nbsp;
                            <a href="../tags/tech.html">tech</a>&nbsp;
                    </td>
    </tr>
            </table>
                                <p>Kindle<sup id="fnref1:1"><a href="converting-kindle-notes-to-markdown.html#fn:1" class="footnote-ref">1</a></sup> has a really cool feature that allows you to email yourself all the notes you've taken for a book. They do this by attaching an HTML file with your notes to the email.</p>
<p>I store all of my notes in <a target="_blank" rel="noopener noreferrer" href="https://obsidian.md/">Obsidian</a>, which uses Markdown. I thought, &quot;Okay, I'll just use <a target="_blank" rel="noopener noreferrer" href="https://pandoc.org/">Pandoc</a> to convert the HTML to Markdown. No problem!&quot;</p>
<pre><code class="language-bash">pandoc -w markdown_strict -s -r html my_notes.html -o my_notes.md</code></pre>
<h2 id='enter-amazons-dumpster-fire-html'><a class='no-underline text-stone-200 hover:text-chartreuse' href='converting-kindle-notes-to-markdown.html#enter-amazons-dumpster-fire-html'>Enter: Amazon's Dumpster Fire HTML</a></h2>
<p>This basically just output a bunch of plain text — no title, headings, lists, etc. That's when I realized that the notes file that Amazon sent me uses absolutely zero semantic HTML, opting instead for the ole divs-for-everything approach to web design.<sup id="fnref1:2"><a href="converting-kindle-notes-to-markdown.html#fn:2" class="footnote-ref">2</a></sup> Then I thought, &quot;Well, I guess it's time to bust out some Perl.&quot;</p>
<p>For book notes, I have one <code>h1</code> heading for the title, an <code>h2</code> heading for each chapter, and each note or idea that I have, I use a list item. Here's an example from a book I recently read, <em>Moonwalking with Einstein</em>:</p>
<pre><code class="language-text">## ONE: THE SMARTEST MAN IS HARD TO FIND

+ *Page 13*: The reason for the monitored decline in human memory performance is because we actually do anti-Olympic training.

## TWO: THE MAN WHO REMEMBERED TOO MUCH

+ *Page 27*: "Somewhere in your mind there's a trace from everything you've ever seen."
+ *Page 42*: if there were one precept that could be said to govern his life, it is that one's highest calling is to engage in enriching escapades at every turn.
+ *Page 44*: "It is always to associate the sound of a person's name with something you can clearly imagine. It's all about creating a vivid image in your mind"
+ *Page 44*: "Baker/baker paradox."</code></pre>
<p>And here's the HTML corresponding to the above that Amazon sent me:</p>
<pre><code class="language-html">&lt;div class="sectionHeading"&gt;
    ONE: THE SMARTEST MAN IS HARD TO FIND
&lt;/div&gt;&lt;div class="noteHeading"&gt;
    Highlight(&lt;span class="highlight_yellow"&gt;yellow&lt;/span&gt;) - Page 13 · Location 287
&lt;/div&gt;
&lt;div class="noteText"&gt;
    The reason for the monitored decline in human memory performance is because we actually do anti-Olympic training.
&lt;/div&gt;&lt;div class="sectionHeading"&gt;
    TWO: THE MAN WHO REMEMBERED TOO MUCH
&lt;/div&gt;&lt;div class="noteHeading"&gt;
    Highlight(&lt;span class="highlight_yellow"&gt;yellow&lt;/span&gt;) - Page 27 · Location 472
&lt;/div&gt;
&lt;div class="noteText"&gt;
    Somewhere in your mind there’s a trace from everything you’ve ever seen.”
&lt;/div&gt;&lt;div class="noteHeading"&gt;
    Highlight(&lt;span class="highlight_yellow"&gt;yellow&lt;/span&gt;) - Page 42 · Location 697
&lt;/div&gt;
&lt;div class="noteText"&gt;
    if there were one precept that could be said to govern his life, it is that one’s highest calling is to engage in enriching escapades at every turn.
&lt;/div&gt;&lt;div class="noteHeading"&gt;
    Highlight(&lt;span class="highlight_blue"&gt;blue&lt;/span&gt;) - Page 44 · Location 721
&lt;/div&gt;
&lt;div class="noteText"&gt;
    “It is always to associate the sound of a person’s name with something you can clearly imagine. It’s all about creating a vivid image in your mind
&lt;/div&gt;&lt;div class="noteHeading"&gt;
    Highlight(&lt;span class="highlight_yellow"&gt;yellow&lt;/span&gt;) - Page 44 · Location 728
&lt;/div&gt;
&lt;div class="noteText"&gt;
    “Baker/ baker paradox.”
&lt;/div&gt;</code></pre>
<p>Genius.<sup id="fnref1:3"><a href="converting-kindle-notes-to-markdown.html#fn:3" class="footnote-ref">3</a></sup></p>
<h2 id='the-allure-of-regular-expressions'><a class='no-underline text-stone-200 hover:text-chartreuse' href='converting-kindle-notes-to-markdown.html#the-allure-of-regular-expressions'>The Allure of Regular Expressions</a></h2>
<p>I'm well aware of the fact that <a target="_blank" rel="noopener noreferrer" href="https://stackoverflow.com/a/1732454">regular expressions are insufficient to parse HTML</a>. Regular expressions are for parsing <a target="_blank" rel="noopener noreferrer" href="https://en.wikipedia.org/wiki/Regular_grammar">regular languages</a>, and HTML is not a regular language.</p>
<p>But, alas, regexes are like sirens leading unwary sailors astray. &quot;Just one line,&quot; they sing. I oblige. They call out again, &quot;There you go. That wasn't so bad. Just one more.&quot; Rapt in their pithy syntax, I indulge myself further.</p>
<pre><code class="language-bash">cat my_notes.html |\
perl -pe 's|\n||g' | \
perl -pe 's|&lt;div class="sectionHeading"&gt;(.*?)&lt;/div&gt;|\n\n##\1\n\n|g' | \
perl -pe 's|&lt;div class="noteHeading"&gt;|+|g' | \
perl -pe 's&amp;Highlight\(&lt;span class="highlight_(yellow|blue|orange)"&gt;(yellow|blue|orange)&lt;/span&gt;\)&amp;&amp;g' | \
perl -pe 's| · Location \d+&lt;/div&gt;&lt;div class="noteText"&gt;|:|g' | \
perl -pe 's|&lt;/div&gt;||g' | \
perl -pe 's|\+\s+Note -|\n+ **Note** — |g' | \
perl -pe 's|\+\s+- Page (\d+):|\n+ Page \1:|g' | \
perl -pe 's|(Page \d+):|*\1*:|g' | \
tail -n +2 | \
pbcopy</code></pre>
<p>Here's an explanation of what each of these commands does:</p>
<ul>
<li><code>perl -pe</code> is basically a drop-in replacement for <code>sed</code>, but with more powerful regexes.<sup id="fnref1:4"><a href="converting-kindle-notes-to-markdown.html#fn:4" class="footnote-ref">4</a></sup> The <code>-p</code> stands for &quot;print&quot;. It's what makes Perl act like a stream editor (i.e., like <code>sed</code>). <code>-e</code> stands for execute and basically just tells Perl to execute the following script for each line in the file. You can also edit files in place using <code>-i</code> just like in <code>sed</code>. Maybe it's the lessons I've learned from functional programming, but I prefer not to edit files in place.</li>
<li><code>perl -pe 's|\n||g'</code> removes all newlines.<sup id="fnref1:5"><a href="converting-kindle-notes-to-markdown.html#fn:5" class="footnote-ref">5</a></sup> The <code>.</code> in Perl regexes doesn't match newlines, so this just makes all further processing easier.</li>
<li><code>perl -pe 's|&lt;div class="sectionHeading"&gt;(.*?)&lt;/div&gt;|\n\n##\1\n\n|g'</code> — convert those ridiculous <code>&lt;div&gt;</code> headings to actual headings. Note that the <code>?</code> after the <code>*</code> makes <code>*</code> lazy instead of greedy. This option is not available in the POSIX regexes that <code>sed</code> uses.</li>
<li><code>perl -pe 's|&lt;div class="noteHeading"&gt;|+|g'</code> — this converts each note to a Markdown list item, <code>+</code>.</li>
<li><code>perl -pe 's&amp;Highlight\(&lt;span class="highlight_(yellow|blue|orange)"&gt;(yellow|blue|orange)&lt;/span&gt;\)&amp;&amp;g'</code> — remove the stupid HTML for highlights. I delimit with <code>&amp;</code> to avoid conflicts with <code>|</code> (used for logical OR) and <code>/</code>.</li>
<li><code>perl -pe 's| · Location \d+&lt;/div&gt;&lt;div class="noteText"&gt;|:|g'</code> — Kindle books come with &quot;location&quot; information in addition to pages. I have no idea what it means, and I don't care. I just use page numbers. So I delete the location info, the following <code>div</code>, and append a <code>:</code> (page number precedes this and the actual note text will follow).</li>
<li><code>perl -pe 's|\+\s+Note -|\n+ **Note** — |g'</code> — there are two types of lines in <code>my_notes.html</code> — one is just a plain quote from the book; the other is a quote with a note that I typed. Lines that start with <code>Note</code> indicate the latter. Obviously, I would like to preserve this information. This line puts <code>Note</code> s on a new line and make the <code>Note</code> word bold.</li>
<li><code>perl -pe 's|\+\s+- Page (\d+):|\n+ Page \1:|g'</code> — this line basically does the same as the above, but for non- <code>Note</code> lines.</li>
<li><code>perl -pe 's|(Page \d+):|*\1*:|g'</code> — Italicize page numbers.</li>
<li><code>tail -n +2</code> — remember that we converted everything to a single line? The preceding regexes moved relevant content to their own lines. What's left at the top is garbage that I don't care about. This line prints the resulting file starting from the second (<code>+2</code>) line.</li>
</ul>
<h2 id='shouldve-used-beautifulsoup-from-the-get-go'><a class='no-underline text-stone-200 hover:text-chartreuse' href='converting-kindle-notes-to-markdown.html#shouldve-used-beautifulsoup-from-the-get-go'>Should've Used BeautifulSoup From the Get-go</a></h2>
<p>The above solution worked fine until I got to a book that had no page numbers. It turns out you can have any variation of page and/or chapter number.  Here's the function I use to parse that:</p>
<pre><code class="language-python">def parse_chapter(text):
    # There is NO chapter number, but there is A page number. Example -&gt;
    # Highlight(&lt;span class="highlight_orange"&gt;orange&lt;/span&gt;) - Page xxvii · Location 381
    if '&gt;' not in text and 'Page' in text:
        page = text.split('Page')[1].split('·')[0].strip()
        return None, page

    # There is A chapter number, but there is NO page number. Example -&gt;
    # Highlight(&lt;span class="highlight_orange"&gt;orange&lt;/span&gt;) - I &gt; Location 38
    # Note: BS parses the &lt;span&gt;
    if '&gt;' in text and 'Page' not in text:
        chapter = text.split('&gt;')[0].strip()
        chapter = chapter.split('Highlight(orange) -')[1].strip()
        return chapter, None

    # There is A chapter number, and there is A page number. Example -&gt;
    # Highlight(&lt;span class="highlight_orange"&gt;orange&lt;/span&gt;) - I.1 Enter the two Bishops, [the Archbishop] of Canterbury and [the Bishop of] Ely. &gt; Page 7 · Location 778
    if '&gt;' in text and 'Page' in text:
        chapter = text.split('Highlight(orange) -')[1]\
                      .split('&gt;')[0].strip()
        page = text.split('Page')[1].split('·')[0].strip()
        return chapter, page

    # There is NO chapter number, and there is NO page number
    return None, None</code></pre>
<p>From there, we basically just find the first &quot;section&quot; node (<code>start_node = soup.find('div', {'class': 'sectionHeading'})</code>) and loop until there are no more siblings: <code>while current.next_sibling:</code>.</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://gist.github.com/dempe/f26536e2d04c2e8e815e0abf7d8d2d69">Here</a> is the full script.  I also have a full repository with unit tests, but my unit tests run on my actual notes, which I'd like to keep private.</p>
<h2 id='footnotes'><a class='no-underline text-stone-200 hover:text-chartreuse' href='converting-kindle-notes-to-markdown.html#footnotes'>Footnotes</a></h2>
<div class="footnotes">
<hr />
<ol>
<li id="fn:1">
<p>Overall, I'm much more of a fan of Kobo; however, I use Kindle for 3 reasons: 1. Using multiple libraries (via <a target="_blank" rel="noopener noreferrer" href="https://www.overdrive.com/">Overdrive</a>) with Kobo is a nightmare, 2. I can read my Kindle books on my phone, and 3. What this post is about — the ability to email myself the notes I've taken is really convenient.&#160;<a href="converting-kindle-notes-to-markdown.html#fnref1:1" rev="footnote" class="footnote-backref">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Not sure if <code>body</code> counts as semantic HTML, but <em>they don't even use it</em>! (See next footnote). 😒&#160;<a href="converting-kindle-notes-to-markdown.html#fnref1:2" rev="footnote" class="footnote-backref">&#8617;</a></p>
</li>
<li id="fn:3">
<p>They even have a <code>&lt;div class="bodyContainer"&gt;</code>, completely redundant to <code>body</code>! I'm convinced that whoever wrote this intentionally made it bad.&#160;<a href="converting-kindle-notes-to-markdown.html#fnref1:3" rev="footnote" class="footnote-backref">&#8617;</a></p>
</li>
<li id="fn:4">
<p>Perl does not use POSIX regexes like <code>sed</code>. As we'll see, this is actually imperative, since there's no way to use the lazy quantifier, <code>?</code>, in POSIX. See <a target="_blank" rel="noopener noreferrer" href="https://en.wikipedia.org/wiki/Comparison_of_regular_expression_engines#Language_features">Comparison of regular expression engines</a>.&#160;<a href="converting-kindle-notes-to-markdown.html#fnref1:4" rev="footnote" class="footnote-backref">&#8617;</a></p>
</li>
<li id="fn:5">
<p><code>|</code> is my favorite delimiter. It's easier to see, and you have to escape it less.&#160;<a href="converting-kindle-notes-to-markdown.html#fnref1:5" rev="footnote" class="footnote-backref">&#8617;</a></p>
</li>
</ol>
</div>
    </article>
</main>
<footer>
        <nav class="hidden md:flex md:flex-row justify-between border-t-4 pt-8">
        <div>
                            <span>⬅️ <a href="carlota.html">Carlota</a></span>
                    </div>
        <div>
                            <span><a href="various-solutions-to-3sum.html">Various Solutions to 3SUM</a> ➡️</span>
                    </div>
    </nav>

    <ul class="md:hidden">
                    <li class="font-bold text-stone-200 mb-2">Previous post: <a href="carlota.html">Carlota</a></li>
                            <li class="font-bold text-stone-200">Next post: <a href="various-solutions-to-3sum.html">Various Solutions to 3SUM</a></li>
            </ul>
        <h2 id="comments"><a class='no-underline text-stone-200 hover:text-white' href="converting-kindle-notes-to-markdown.html#comments">Comments</a></h2>
    <script src="https://giscus.app/client.js"
            data-repo="dempe/blog-comments"
            data-repo-id="R_kgDOLfkyrQ"
            data-category-id="DIC_kwDOLfkyrc4Cd7x2"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="0"
            data-emit-metadata="0"
            data-input-position="top"
            data-theme="dark"
            data-lang="en"
            data-loading="lazy"
            crossorigin="anonymous"
            async>
    </script>
</footer>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script>hljs.highlightAll();</script>

    
    
    
    

    
    
    
    
    
    
    
    
    
    
</body>
</html>
